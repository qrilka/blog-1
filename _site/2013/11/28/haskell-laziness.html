<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<link href='http://fonts.googleapis.com/css?family=Cuprum:400,400italic,700&subset=latin,cyrillic,latin-ext' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lobster&subset=latin,cyrillic,latin-ext' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Philosopher:400,400italic,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
<title>Haskell: что же это за ленивые вычисления такие? &#8211; Д. Шевченко</title>
<meta name="description" content="Программист, исследователь, писатель">
<meta name="keywords" content="">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://denisshevchenko.github.io/blog/images/site-logo.png">
<meta name="twitter:title" content="Haskell: что же это за ленивые вычисления такие?">
<meta name="twitter:description" content="Программист, исследователь, писатель">
<meta name="twitter:creator" content="@dshevchenko_biz">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Haskell: что же это за ленивые вычисления такие?">
<meta property="og:description" content="Программист, исследователь, писатель">
<meta property="og:url" content="http://denisshevchenko.github.io/blog/2013/11/28/haskell-laziness.html">
<meta property="og:site_name" content="Д. Шевченко">





<link rel="canonical" href="http://denisshevchenko.github.io/blog/2013/11/28/haskell-laziness.html">
<link href="http://denisshevchenko.github.io/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Д. Шевченко Feed">
<link rel="author" href="https://google.com/+DenisShevchenko?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://denisshevchenko.github.io/blog/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://denisshevchenko.github.io/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://denisshevchenko.github.io/blog/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://denisshevchenko.github.io/blog/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://denisshevchenko.github.io/blog/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://denisshevchenko.github.io/blog/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://denisshevchenko.github.io/blog/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://denisshevchenko.github.io/blog/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="http://denisshevchenko.github.io/blog/articles/">Записи</a>
				 
			</li>
	        
			<li>
				
					<a href="http://denisshevchenko.github.io/blog/friends/">Друзья</a>
				 
			</li>
	        
			<li>
				
					<a href="http://denisshevchenko.github.io/blog/about/">О себе</a>
				 
			</li>
	        
			<li>
				
					<a href="http://ohaskell.ru">О Haskell</a>
				 
			</li>
	        
	        <li><a href="http://denisshevchenko.github.io/blog/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Поиск</li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Ищем...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="http://denisshevchenko.github.io/blog/" class="site-logo" rel="home" title="Д. Шевченко"><img src="http://denisshevchenko.github.io/blog/images/site-logo.png" width="200" height="200" alt="Д. Шевченко logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="http://denisshevchenko.github.io/blog/">Д. Шевченко</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Программист, исследователь, писатель</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"></span>
        
          <h1 class="entry-title">Haskell: что же это за ленивые вычисления такие?</h1>
        
      </header>
      <footer class="entry-meta">
        <!-- <img src="http://denisshevchenko.github.io/blog/images/bio-photo.jpg" alt="Денис Шевченко photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="http://denisshevchenko.github.io/blog/about/" title="About Денис Шевченко">Денис Шевченко</a></span></span> -->
        <span class="entry-date date published"><time datetime="2013-11-28T00:00:00+04:00"><i class="icon-calendar-empty"></i> November 28, 2013</time></span>
        
        <span><a href="http://denisshevchenko.github.io/blog/2013/11/28/haskell-laziness.html" rel="bookmark" title="Haskell: что же это за ленивые вычисления такие?"><i class="icon-link"></i> Вечная ссылка</a></span>
        
        
      </footer>
      <div class="entry-content">
        <!--break-->
<p>Вот формальное определение:</p>

<p><strong>“Lazy evaluation is an evaluation strategy which delays the evaluation of an expression until its value is needed.”</strong></p>

<p>Ну вроде бы всё понятно: откладываем вычисление выражения до тех пор, пока оно кому-то не понадобится. Но поскольку я привык думать концепциями языка C++, я не мог понять, где тут изюминка и как это проявляется на практике. И вот недавно, благодаря одному руководству по Haskell, я наконец-то вкурил. Как это обычно бывает, всё оказалось проще нежели я думал.</p>

<p>Итак, представьте себе, что у нас есть список из 100 одинаковых IP-адресов. Не важно, зачем нам могло бы понадобится такое в реальной жизни, но допустим… И вот нам потребовалось получить первые два из этих адресов с выводом их на консоль.</p>

<p>На C++ это выглядело бы примерно так:</p>

<div class="highlight"><pre><code class="cpp"><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">IP_addresses</span><span class="p">;</span>

<span class="n">IP_addresses</span> <span class="nf">generate_addresses</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">how_many</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">IP_addresses</span> <span class="n">addresses</span><span class="p">(</span> <span class="n">how_many</span><span class="p">,</span> <span class="s">&quot;127.0.0.1&quot;</span> <span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span> <span class="n">addresses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">how_many</span> <span class="p">);</span>
    <span class="k">return</span> <span class="n">addresses</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">take_and_print</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">how_many</span><span class="p">,</span> <span class="k">const</span> <span class="n">IP_addresses</span><span class="o">&amp;</span> <span class="n">addresses</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">how_many</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">take_and_print</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">generate_addresses</span><span class="p">(</span> <span class="mi">100</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Выводом этой программы будет:</p>
<bash>
127.0.0.1
127.0.0.1
</bash>

<p>Вопрос: сколько строк, соответствующих IP-адресам, было фактически создано функцией <code>generate_addresses()</code>? Разумеется, 100, о чём нам неопровержимо свидетельствует проверка с помощью <code>assert</code>. А теперь второй вопрос: сколько из этих 100 адресов фактически понадобилось внешнему контексту, а именно вызывающей функции <code>take_and_print()</code>? Только два первых.</p>

<p>Таким образом, мы можем констатировать, что раз уж из 100 созданных строк фактически потребовались лишь первые две, то оставшиеся 98 строк были созданы абсолютно напрасно. Было затрачено время на создание этих 98 строк, была затрачена память для их сохранения - и всё впустую.</p>

<p>Это - строгость вычислений, присущая языку C++. Функция <code>generate_addresses()</code> прямолинейна и сразу рвётся в бой. Сказали ей создать 100 адресов - получите 100. Скажут создать миллион - пожалуйста, вот вам миллион. Скажут миллиард - ну что ж, потерпите чуток, но будет вам и миллиард.</p>

<p>Тем временем функция <code>take_and_print()</code> столь же прямолинейна, и ей абсолютно наплевать на усилия трудолюбивой функции <code>generate_addresses()</code>. Если ей сказали отобразить лишь первые два элемента полученного контейнера, именно так она и сделает. И ей без разницы, сколько там <em>ещё</em> элементов в том контейнере, 2 или 2 миллиарда.</p>

<p>Результатом такой строгости является лишняя работа (в данном случае аж 98% оказались лишними). Но функции в языке Haskell, в отличие от трудолюбивых коллег из C++, терпеть не могут лишней работы.</p>

<p>Запустим интерпретатор <strong>ghci</strong> и напишем:</p>

<div class="highlight"><pre><code class="haskell"><span class="o">&gt;</span> <span class="n">take</span> <span class="mi">2</span> <span class="p">(</span><span class="n">replicate</span> <span class="mi">100</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Эта строка делает всю ту же работу: функция <code>replicate</code> создаёт список из 100 строк с нашим IP-адресом и передаёт его в качестве второго аргумента функции <code>take</code>, которая в свою очередь берёт лишь первые два элемента из этого списка и выводит их.</p>

<p>Но весь фокус в том, что функция <code>replicate</code> <em>на самом деле</em> создаёт список вовсе не из 100 строк, а всего из двух. Почему? Потому что внешнему контексту нужно лишь две. :)</p>

<p>Функция <code>replicate</code> - лентяйка. Она как бы смотрит по сторонам и думает: “Так-с, кому тут нужны мои строки. Ага, функции <code>take</code> нужны. И сколько же? А-а, всего две. Ну так а чего я, глупая что ли, создавать сто, когда требуется всего две?! Вот тебе две и будь счастлива!” </p>

<p>И несмотря на то, что трудолюбие - это хорошо, а лень - это плохо, в данном случае мне более симпатична функция-лентяйка. Она как хороший рационализатор, делает не столько, сколько её попросили, а столько, сколько реально необходимо. В этом и заключается суть ленивых вычислений в Haskell.</p>

<p>Разумеется, если аппетиты функции <code>take</code> возрастут и она попросит первые 50 элементов вместо первых двух, то функция <code>replicate</code> создаст список уже из 50 строк. Столько, сколько нужно, и ни капли больше.</p>

<p>Но внимательный читатель скажет мне: “Э-э, друг, погоди-ка! А откуда мне знать, что функция <code>replicate</code> действительно создаёт лишь столько IP-адресов, сколько нужно? Может, она каждый раз и создаёт 100 строк, как в C++! Докажи обратное!”</p>

<p>Что ж, с радостью докажу обратное. Дело в том, что в языке Haskell можно оперировать бесконечно большими списками. Нет, не просто очень большими, но именно бесконечными. Перепишем пример следующим образом:</p>

<div class="highlight"><pre><code class="haskell"><span class="o">&gt;</span> <span class="n">take</span> <span class="mi">2</span> <span class="p">(</span><span class="n">cycle</span> <span class="p">[</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">])</span>
</code></pre></div>

<p>Функция <code>cycle</code> создаёт бесконечно большой список на основе списка, полученного ею в качестве аргумента. В данном случае мы передали ей список из одной-единственной строки “127.0.0.1”, а она создаст из него список с бесконечно большим количеством этих же строк.</p>

<p>И если бы наша трудолюбивая функция <code>generate_addresses</code> захотела стать похожей на свою ленивую коллегу, её пришлось бы переписать так:</p>

<div class="highlight"><pre><code class="cpp"><span class="n">IP_addresses</span> <span class="nf">generate_addresses</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">how_many</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">IP_addresses</span> <span class="n">addresses</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">addresses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="s">&quot;127.0.0.1&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">addresses</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Но мой внимательный читатель возразит: “Чё за бред! Это же зависнет намертво, пока процесс не будет убит!”</p>

<p>Конечно зависнет. И виной тому уже известное нам трудолюбие функции <code>generate_addresses</code>. Сказали создать бесконечно большой список - буду создавать до последнего вздоха.</p>

<p>Однако если мы выполним это:</p>

<div class="highlight"><pre><code class="haskell"><span class="o">&gt;</span> <span class="n">take</span> <span class="mi">2</span> <span class="p">(</span><span class="n">cycle</span> <span class="p">[</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">])</span>
<span class="p">[</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">]</span>
</code></pre></div>

<p>не будет никакого зависания, и результат мы получим правильный. Ну в самом деле, зачем создавать бесконечно длинный список, если в конечном итоге потребовались лишь первые два его элемента? То есть функция <code>cycle</code> начинает создавать бесконечно большой список, но создав лишь два первых его элемента, сразу останавливается, потому что понимает, что третий и все последующие элементы так никогда и не понадобятся…</p>

<p>Ах да, я и забыл, что мой читатель внимателен. Он может потребовать доказательств, что функция <code>cycle</code> действительно создаёт бесконечно большой список. Ну что ж, пусть выполнит это:</p>

<div class="highlight"><pre><code class="haskell"><span class="o">&gt;</span> <span class="n">cycle</span> <span class="p">[</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">])</span>
</code></pre></div>

<p>Только пусть держит пальцы на Ctrl+C наготове, потому что на экран очень быстро посыпется очень много строчек… :)</p>

<p>Итак, вот простая суть ленивых вычислений в Haskell: не важно, сколько приказали сделать, ведь что в конечном итоге будет сделано лишь столько, сколько реально нужно.</p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://denisshevchenko.github.io/blog/2013/11/8/sizeof-sizeof-sizeof.html" class="btn" title="sizeof, sizeof и ещё раз sizeof">Предыдущий</a>
      
      
        <a href="http://denisshevchenko.github.io/blog/2013/11/28/language-studying.html" class="btn" title="К вопросу о продолжительности изучения языков...">Следующий</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2011-2014 Денис Шевченко. Сайт работает на <a href="http://jekyllrb.com">Jekyll</a> с использованием <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/dshevchenko_biz" title="В Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	<a href="http://facebook.com/dshevchenko.biz" title="На Facebook" target="_blank"><i class="icon-facebook icon-2x"></i></a>
	<a href="https://google.com/+DenisShevchenko" title="На Google+" target="_blank"><i class="icon-google-plus icon-2x"></i></a>
	<a href="http://linkedin.com/in/dshevchenkobiz" title="И в LinkedIn я тоже есть" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	<a href="http://stackexchange.com/users/131381/denis-shevchenko" title="И даже на StackExchange я есть" target="_blank"><i class="icon-stackexchange icon-2x"></i></a>
	
	
	<a href="http://github.com/denisshevchenko" title="И конечно же на Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://denisshevchenko.github.io/blog/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://denisshevchenko.github.io/blog/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://denisshevchenko.github.io/blog/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


	        

</body>
</html>
