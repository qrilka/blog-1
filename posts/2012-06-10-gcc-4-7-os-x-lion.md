---
layout: post
title: GCC 4.7 на OS X Lion: тернистый путь...
category: articles
tags: GCC, OS X
comments: true
share: true
---
Уффф... Наконец-то заработало...

В общем, поставить GCC 4.7 на OS X Lion оказалось делом не столь тривиальным. Казалось бы, после успешных установок **<a href="http://dshevchenko.biz/ru/content/gcc-%D0%B4%D0%B2%D0%B0-%D0%BA%D0%BE%D0%BC%D0%BF%D0%B8%D0%BB%D1%8F%D1%82%D0%BE%D1%80%D0%B0-%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%B5">GCC 4.6.2 и 4.7.0 на Debian</a>** проблем у меня не должно было быть никаких, ан нет...

Ну, начну с того, что собирал я GCC не совсем правильно. Вернее, не тем способом, который рекомендуют разработчики GCC. Оказывается, скачивать и отдельно устанавливать библиотеки GMP, MPC и MPFR *не нужно*! Почему? Потому что GCC, как оказалось, умеет делать это самостоятельно. Кроме того, конфигурировал я тоже не совсем правильно. Итак, по порядку...

Скачиваем gcc-4.7.0.tar.bz2, распаковываем и заходим внутрь:
```cpp
cd gcc-4.7.0
```
А вот теперь следуем простым инструкциям, взятым **<a href="http://gcc.gnu.org/wiki/InstallingGCC">отсюда</a>**. Итак:
```cpp
./contrib/download_prerequisites
cd ..
mkdir gcc_build
cd gcc_build
/Users/dshevchenko/Downloads/gcc-4.7.0/configure --prefix=/Users/dshevchenko/Tools/GCC 
make
make install
```
Итак, в первой строке запускается небольшой скрипт, автоматически загружающий нужные версии MPFR, MPC и GMP и распаковывающий их архивы. Суть в том, что ставить эти библиотеки отдельно не нужно, поскольку в этом случае могут возникнуть проблемы с путями к ним (динамический линковщик ругается). Если же они скачиваются с помощью данного скрипта, то собираюсь и линкуются *статически*, и вам уже не придётся об этом беспокоиться.

Далее, обращаю ваше внимание, мы **выходим** из gcc-4.7.0. Оказывается, это важный пункт, поскольку в официальной документации к GCC указано:** "крайне не рекомендуем конфигурировать и собирать GCC, находясь внутри дерева исходников GCC или в одной из подпапок"**. Нужно обязательно извне! Честно признаться, я так и не понял, почему это столь важно (ведь на Debian я собирал, находясь в корне gcc-4.7.0, и всё было ОК), но раз рекомендуется, так и сделаем.

Обращаю ваше внимание и на то, что в конфигурации мы указали лишь **--prefix**, а опции **--with-mpc**, **--with-gmp** и **--with-mpfr** нам уже, естественно, не нужны.

Далее проходит конфигурирование, и начинается компиляция. Однако...

<h4>Подводный камень.</h4>

К сожалению, компиляция вскоре прерывается со следующей ошибкой:
```cpp
checking for suffix of object files... configure: error: 
in `/Users/dshevchenko/Downloads/gcc_build/x86_64-apple-darwin11.4.0/libgcc':
configure: error: cannot compute suffix of object files: cannot compile
See `config.log' for more details.
```Каноническая причина этой странной ошибки сводится к тому, что динамический линковщик не видит те самые служебные библиотеки GMP, MPC и/или MPFR. Но ведь мы собрали их статически, следовательно, причина в другом.

Дооооолгое гугление и блуждание по спискам рассылки, stackoverflow.com и различным форумам натолкнули меня на **<a href="http://comments.gmane.org/gmane.comp.gcc.bugs/327499">эту</a>** страницу, а потом - на **<a href="http://llvm.org/bugs/show_bug.cgi?id=9571">эту</a>**. В общем, там имеет место один баг в Apple-вском llvm-gcc-4.2.1, и многие спотыкались об него.

Решение оказалось неожиданно простым: необходимо определить две переменны среды:
```cpp
export CC=gcc-4.2
export CXX=g++-4.2
```
Не знаю почему, но компиляция успешно продолжится. Наберитесь терпения...

Итак, всё готово, затем мы делаем make install - и всё ок.

Далее необходимо определить переменную среды DYLD_LIBRARY_PATH. В моём случае это:
```cpp
export DYLD_LIBRARY_PATH=/Users/dshevchenko/Tools/GCC/lib
```
Это нужно для того, чтобы при компиляции моих программ компилятор подцеплял свежесобранную стандартную библиотеку, поскольку пути, указанные в переменной DYLD_LIBRARY_PATH, просматриваются динамическим линковщиком **прежде** стандартных путей, что чрезвычайно удобно.

А теперь облегчённо вздохнём - и наслаждается GCC 4.7.0 на нашем Льве.
