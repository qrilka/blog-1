<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content>
        <meta name="author" content="Денис Шевченко">
        <link rel="icon" href="../../../static/images/favicon.ico">

        <title>Boost.DateTime: логический баг...</title>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

        <link href="../../../static/css/default.css" rel="stylesheet">
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

        <script>
          window.___gcfg = {
            lang: 'ru'
          };
        </script>

        <script src="https://apis.google.com/js/platform.js" async defer>
        </script>
    </head>

  <body>
    <div class="container">
        <nav class="navbar navbar-default navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="logo">
                <a class="navbar-brand" href="../../../" title="Домой">
                  Мысли и опыт
                </a>
              </div>
            </div>
            
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li><a href="../../../tags.html">Темы</a></li>
                <li><a href="../../../archive.html">Архив</a></li>
                <li><a href="../../../feed.xml">RSS</a></li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li><a href="http://dshevchenko.biz" target="_blank">root</a></li>
              </ul>
            </div>
          </div>
        </nav>

        <div id="content">
            <h1>Boost.DateTime: логический баг...</h1>

<div class="row">
    <div class="col-xs-5 col-sm-5 col-md-4 col-lg-4">
        <div class="post-info">
            <strong>where</strong> date = "04 ноября 2011"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags = [<a href="../../../tags/boost.html">boost</a>]
        </div>
    </div>

    <div class="col-xs-2 col-sm-2 col-md-4 col-lg-4"></div>
  
    <div class="col-xs-5 col-sm-5 col-md-4 col-lg-4">
        
    </div>
</div>

<p>В нашем проекте мы столкнулись с проблемой, когда в объекте <strong>boost::posix_time::ptime</strong> в определённой ситуации появлялся мусор. Я разобрался, и вот что обнаружил.</p>
<p>Итак, простой пример:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( time_from_string( <span class="st">&quot;2011-01-01 00:00:00&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
Вывод:
<pre>
2011-Jan-01 00:00:00
</pre>
<p>Всё нормально. Но что будет, если мы не зададим время <em>явно</em>?</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( time_from_string( <span class="st">&quot;2011-01-01&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
На моём компьютере вывод оказался таким:
<pre>
2011-Mar-25 19:01:01
</pre>
<p>Э-э… В высшей степени странный результат… Оказывается, время задавать <em>необходимо</em>. Но пусть бы тогда библиотека хоть исключение выкидывала, это по крайней мере заметно. А тут молча имеем какой-то мусор.</p>
<p>Более того, тот же казус имеем и с другим способом:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( from_iso_string( <span class="st">&quot;20110101T000000&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
Вывод:
<pre>
2011-Jan-01 00:00:00
</pre>
<p>Опять-таки всё в порядке. Но если без времени:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( from_iso_string( <span class="st">&quot;20110101&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
то вывод получаем не менее странный:
<pre>
2011-Jan-01 20:11:01.100000
</pre>
<p>Значит, и тут время необходимо задавать. Но и тут никакого исключения, а лишь молчаливый мусор… Причём ошибки ISO-формата тут нет, 20110101 - это нормальная дата в соответствии с ISO 8601.</p>
<p>По моему убеждению, здесь имеет место логическая ошибка. Ведь если мы задали лишь дату (то есть конкретные сутки конкретного месяца конкретного года), но не указали время, то вполне логично предположить, что мы имели в виду <em><ins>начало</ins></em> этих суток, то есть 00:00:00. Поэтому в случае <em>отсутствия</em> времени никакого исключения быть, по-хорошему, не должно, а вместо него должен подставляться момент начала суток. Так почему же этого не происходит?</p>
<p>А всё просто. Дело в том, что в реализациях функций <strong>time_from_string()</strong> и <strong>from_iso_string()</strong> предполагается, что разделитель (в первом случае - пробел, а во втором случае - буква T) даты и времени присутствует <em>всегда</em>. И поэтому никакой проверки наличия этого разделителя не производится. Жаль.</p>
<p>Так что, друзья, знайте об этом баге и будьте внимательны.</p>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dshevchenko'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

        </div> 

        <div id="searchForm">
            <script>
              (function() {
                var cx = '007697214108744450483:ccjauglh7ao';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>

        <footer class="footer">
            Сайт работает на <strong><a href="http://jaspervdj.be/hakyll/" target="_blank">Hakyll</a></strong> и живёт на <strong><a href="https://github.com/denisshevchenko/blog" target="_blank">GitHub</a></strong>.
            <div class="copyright-note">
                Исходный код данного сайта, а также все опубликованные на нём материалы распространяются на условиях <a href="https://github.com/denisshevchenko/blog/blob/master/LICENSE" target="_blank">свободной лицензии MIT</a>.
            </div>
        </footer>
    </div>
  </body>
</html>

