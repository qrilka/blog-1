<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Boost.DateTime: логический баг...</title>
        
        <link rel="stylesheet" type="text/css" href="../../../css/default.css" />
        <link rel="icon" type="image/x-icon" href="../../../images/favicon.ico" />

        <script src="https://apis.google.com/js/platform.js" async defer>
            {lang: 'ru'}
        </script>
    </head>
    <body>
        <div id="wrapper">
        <div id="wrapper_2">
        
        <div id="header">
            <div id="logo">
                <a href="http://blog.dshevchenko.biz" title="Домой">Д. Шевченко</a><span class="logo-note">Программист, исследователь, писатель</span>
            </div>
            <div id="navigation">
                <a href="http://dshevchenko.biz" title="К корневому сайту"><span id="root_link">cd /</span></a>
                <a href="http://blog.dshevchenko.biz/archive.html">АРХИВ</a>
                <a href="http://blog.dshevchenko.biz/tags.html">ТЕМЫ</a>
                <a href="http://blog.dshevchenko.biz/feed.xml">RSS</a>
            </div>
        </div>

        <div id="content">
            <h1>Boost.DateTime: логический баг...</h1>

            <div class="info">
    (2011, 11, 04)
</div>

<div id="tags_of_post">
    <a href="../../../tags/boost.html">boost</a>
</div>

<div style="padding-top: 20px;"></div>

<p>В нашем проекте мы столкнулись с проблемой, когда в объекте <strong>boost::posix_time::ptime</strong> в определённой ситуации появлялся мусор. Я разобрался, и вот что обнаружил.</p>
<p>Итак, простой пример:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( time_from_string( <span class="st">&quot;2011-01-01 00:00:00&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
Вывод:
<pre>
2011-Jan-01 00:00:00
</pre>
<p>Всё нормально. Но что будет, если мы не зададим время <em>явно</em>?</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( time_from_string( <span class="st">&quot;2011-01-01&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
На моём компьютере вывод оказался таким:
<pre>
2011-Mar-25 19:01:01
</pre>
<p>Э-э… В высшей степени странный результат… Оказывается, время задавать <em>необходимо</em>. Но пусть бы тогда библиотека хоть исключение выкидывала, это по крайней мере заметно. А тут молча имеем какой-то мусор.</p>
<p>Более того, тот же казус имеем и с другим способом:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( from_iso_string( <span class="st">&quot;20110101T000000&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
Вывод:
<pre>
2011-Jan-01 00:00:00
</pre>
<p>Опять-таки всё в порядке. Но если без времени:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">int</span> main() {
    <span class="kw">using</span> <span class="kw">namespace</span> boost::posix_time;
    ptime tm( from_iso_string( <span class="st">&quot;20110101&quot;</span> ) );
    std::cout &lt;&lt; tm &lt;&lt; std::endl;
}</code></pre>
то вывод получаем не менее странный:
<pre>
2011-Jan-01 20:11:01.100000
</pre>
<p>Значит, и тут время необходимо задавать. Но и тут никакого исключения, а лишь молчаливый мусор… Причём ошибки ISO-формата тут нет, 20110101 - это нормальная дата в соответствии с ISO 8601.</p>
<p>По моему убеждению, здесь имеет место логическая ошибка. Ведь если мы задали лишь дату (то есть конкретные сутки конкретного месяца конкретного года), но не указали время, то вполне логично предположить, что мы имели в виду <em><ins>начало</ins></em> этих суток, то есть 00:00:00. Поэтому в случае <em>отсутствия</em> времени никакого исключения быть, по-хорошему, не должно, а вместо него должен подставляться момент начала суток. Так почему же этого не происходит?</p>
<p>А всё просто. Дело в том, что в реализациях функций <strong>time_from_string()</strong> и <strong>from_iso_string()</strong> предполагается, что разделитель (в первом случае - пробел, а во втором случае - буква T) даты и времени присутствует <em>всегда</em>. И поэтому никакой проверки наличия этого разделителя не производится. Жаль.</p>
<p>Так что, друзья, знайте об этом баге и будьте внимательны.</p>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dshevchenko'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

        </div>
        
        <div id="footer">
            <div id="social">
                <strong>let</strong> social = [<span id="twitter"><a href="https://twitter.com/dshevchenko_biz" title="Twitter">t</a></span>,&nbsp;<span id="googleplus"><a href="http://google.com/+DenisShevchenko" title="Google+">g+</a></span>,&nbsp;<span id="github"><a href="https://github.com/denisshevchenko" title="GitHub">g</a></span>,&nbsp;<span id="facebook"><a href="https://www.facebook.com/dshevchenko.biz" title="Facebook">f</a></span>,&nbsp;<span id="linkedin"><a href="https://www.linkedin.com/in/dshevchenkobiz" title="LinkedIn">in</a></span>]
            </div>
            <div id="hakyll_mark">
                Сайт создан с помощью <a href="http://jaspervdj.be/hakyll">Hakyll</a> и живёт на <a href="https://github.com/denisshevchenko/blog">GitHub</a>
            </div>
        </div>
        
        <div id="search_form">
            <script>
              (function() {
                var cx = '007697214108744450483:ccjauglh7ao';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>
        </div>
        </div>
    </body>
</html>
